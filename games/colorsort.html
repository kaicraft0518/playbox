<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚«ãƒ©ãƒ¼ã‚½ãƒ¼ãƒˆ â€” Playbox</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:opsz,wght@9..144,700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f5f5f2;--surface:#ffffff;--surface2:#f0f0ec;
  --border:#e2e2dc;--text:#1a1a18;--text2:#6b6b63;
  --accent:#2a6b52;--accent-bg:rgba(42,107,82,0.08);
  --accent2:#c0392b;--shadow:0 2px 12px rgba(0,0,0,0.07);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.10);
  --radius:10px;--radius-sm:6px;--transition:0.2s ease;
}
:root.dark {
  --bg:#0a0a0f;--surface:#0f0f1a;--surface2:#15151f;
  --border:#1e1e3a;--text:#e0e0ff;--text2:#5a5a8a;
  --accent:#00c49a;--accent-bg:rgba(0,196,154,0.08);
  --accent2:#ff3c6e;--shadow:0 2px 12px rgba(0,0,0,0.3);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.4);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;transition:background var(--transition),color var(--transition);}
.pb-nav{position:sticky;top:0;z-index:50;background:var(--surface);border-bottom:1px solid var(--border);}
.pb-nav-inner{display:flex;align-items:center;height:56px;gap:12px;max-width:960px;margin:0 auto;padding:0 20px;min-width:0;}
.pb-logo{font-family:'Fraunces',serif;font-weight:700;font-size:1.25rem;color:var(--text);text-decoration:none;letter-spacing:-0.02em;white-space:nowrap;}
.pb-logo span{color:var(--accent);}
.pb-nav-spacer{flex:1;}
.pb-icon-btn{width:36px;height:36px;border-radius:var(--radius-sm);border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.9rem;transition:all var(--transition);flex-shrink:0;}
.pb-icon-btn:hover{background:var(--accent-bg);border-color:var(--accent);color:var(--accent);}
.pb-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;border-radius:var(--radius-sm);border:1px solid var(--border);background:transparent;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;cursor:pointer;transition:all var(--transition);white-space:nowrap;}
.pb-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-bg);}
.pb-btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
.pb-btn.primary:hover{opacity:0.88;}
.pb-seg{display:flex;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;}
.pb-seg-btn{flex:1;padding:6px 14px;background:transparent;border:none;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:0.78rem;font-weight:500;cursor:pointer;transition:all var(--transition);}
.pb-seg-btn+.pb-seg-btn{border-left:1px solid var(--border);}
.pb-seg-btn.active{background:var(--accent);color:white;}
.pb-seg-btn:not(.active):hover{background:var(--accent-bg);color:var(--accent);}

/* Game layout */
.game-wrap{display:flex;flex-direction:column;align-items:center;padding:20px 16px 48px;gap:16px;}

.game-header{width:100%;max-width:560px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
.game-title{font-family:'Fraunces',serif;font-size:1.8rem;font-weight:700;letter-spacing:-0.02em;}

/* Mode & difficulty selector */
.selectors{width:100%;max-width:560px;display:flex;flex-direction:column;gap:10px;}
.sel-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.sel-label{font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--text2);letter-spacing:0.12em;text-transform:uppercase;min-width:48px;}

/* Stats */
.stats-bar{display:flex;gap:8px;width:100%;max-width:560px;flex-wrap:wrap;}
.stat-pill{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:5px 14px;font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text2);letter-spacing:0.06em;display:flex;align-items:center;gap:6px;}
.stat-pill b{color:var(--text);font-weight:500;}
.stat-pill.accent b{color:var(--accent);}

/* Tubes container */
.tubes-wrap{width:100%;max-width:560px;display:flex;flex-wrap:wrap;justify-content:center;gap:10px;}

/* Tube */
.tube-outer{display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;}
.tube{
  width:48px;height:var(--tube-h,192px);
  border:2px solid var(--border);
  border-top:none;
  border-radius:0 0 24px 24px;
  background:var(--surface);
  display:flex;flex-direction:column-reverse;
  overflow:hidden;
  position:relative;
  transition:border-color 0.15s, box-shadow 0.15s, transform 0.15s;
}
.tube.selected{
  border-color:var(--accent);
  box-shadow:0 0 0 2px var(--accent-bg), 0 4px 16px rgba(42,107,82,0.2);
  transform:translateY(-6px);
}
:root.dark .tube.selected{
  box-shadow:0 0 0 2px var(--accent-bg), 0 4px 16px rgba(0,196,154,0.25);
}
.tube.complete{
  border-color:var(--accent);
  background:var(--accent-bg);
}
.tube.empty{
  border-style:dashed;
  opacity:0.5;
}
.tube.shake{
  animation:shake 0.3s ease;
}
@keyframes shake{
  0%,100%{transform:translateX(0);}
  25%{transform:translateX(-5px);}
  75%{transform:translateX(5px);}
}

/* Color segments */
.seg{
  width:100%;
  height:var(--seg-h,48px);
  transition:height 0.2s ease;
  flex-shrink:0;
}
.seg.pouring{
  animation:pour 0.25s ease;
}
@keyframes pour{
  from{transform:scaleY(0);transform-origin:bottom;}
  to{transform:scaleY(1);}
}

/* Tube label */
.tube-label{
  font-family:'DM Mono',monospace;
  font-size:0.55rem;
  color:var(--text2);
  letter-spacing:0.05em;
}

/* Result overlay */
.result-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(245,245,242,0.93);z-index:100;
  align-items:center;justify-content:center;
  flex-direction:column;gap:14px;text-align:center;padding:20px;
}
:root.dark .result-overlay{background:rgba(10,10,15,0.92);}
.result-overlay.show{display:flex;}
.result-emoji{font-size:3.5rem;}
.result-title{font-family:'Fraunces',serif;font-size:2rem;font-weight:700;color:var(--accent);letter-spacing:-0.02em;animation:popIn 0.4s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes popIn{from{transform:scale(0.7);opacity:0;}to{transform:scale(1);opacity:1;}}
.result-stats{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
.result-stat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 20px;}
.result-stat-val{font-family:'Fraunces',serif;font-size:1.5rem;font-weight:700;color:var(--text);}
.result-stat-label{font-family:'DM Mono',monospace;font-size:0.6rem;color:var(--text2);letter-spacing:0.1em;text-transform:uppercase;margin-top:2px;}
</style>
</head>
<body>

<nav class="pb-nav">
  <div class="pb-nav-inner">
    <a href="../index.html" class="pb-logo">Play<span>box</span></a>
    <div class="pb-nav-spacer"></div>
    <button class="pb-icon-btn" id="themeBtn" onclick="toggleTheme()">ğŸŒ¤</button>
  </div>
</nav>

<div class="game-wrap">

  <div class="game-header">
    <div class="game-title">ã‚«ãƒ©ãƒ¼ã‚½ãƒ¼ãƒˆ</div>
    <div style="display:flex;gap:8px;">
      <button class="pb-btn" onclick="undoMove()">â†© æˆ»ã™</button>
      <button class="pb-btn primary" onclick="newGame()">â–¶ NEW</button>
    </div>
  </div>

  <!-- Selectors -->
  <div class="selectors">
    <div class="sel-row">
      <span class="sel-label">é›£æ˜“åº¦</span>
      <div class="pb-seg" id="diffSeg">
        <button class="pb-seg-btn" onclick="setDiff(0)">ã‹ã‚“ãŸã‚“<br><span style="font-size:0.6rem;opacity:0.7">4è‰² 5æœ¬</span></button>
        <button class="pb-seg-btn active" onclick="setDiff(1)">ãµã¤ã†<br><span style="font-size:0.6rem;opacity:0.7">5è‰² 6æœ¬</span></button>
        <button class="pb-seg-btn" onclick="setDiff(2)">ã‚€ãšã‹ã—ã„<br><span style="font-size:0.6rem;opacity:0.7">6è‰² 7æœ¬</span></button>
        <button class="pb-seg-btn" onclick="setDiff(3)">ã‚¹ãƒ†ãƒ¼ã‚¸<br><span style="font-size:0.6rem;opacity:0.7">æ®µéšçš„</span></button>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-pill">æ‰‹æ•° <b id="statMoves">0</b></div>
    <div class="stat-pill" id="statStageWrap" style="display:none">ã‚¹ãƒ†ãƒ¼ã‚¸ <b id="statStage">1</b></div>
    <div class="stat-pill accent">Best <b id="statBest">â€”</b></div>
  </div>

  <!-- Tubes -->
  <div class="tubes-wrap" id="tubesWrap"></div>

</div>

<!-- Result -->
<div class="result-overlay" id="resultOverlay">
  <div class="result-emoji">ğŸ‰</div>
  <div class="result-title">ã‚¯ãƒªã‚¢ï¼</div>
  <div class="result-stats">
    <div class="result-stat">
      <div class="result-stat-val" id="resMoves">â€”</div>
      <div class="result-stat-label">æ‰‹æ•°</div>
    </div>
  </div>
  <div id="resBest" style="font-family:'DM Mono',monospace;font-size:0.75rem;color:var(--accent);letter-spacing:0.08em;"></div>
  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center;">
    <button class="pb-btn" onclick="document.getElementById('resultOverlay').classList.remove('show')">é–‰ã˜ã‚‹</button>
    <button class="pb-btn primary" id="resultNextBtn" onclick="nextLevel()">æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸</button>
    <button class="pb-btn" onclick="newGame();document.getElementById('resultOverlay').classList.remove('show')">ã‚‚ã†ä¸€åº¦</button>
  </div>
</div>

<script>
// â”€â”€ Color palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = [
  { id:0, hex:'#ef4444', name:'èµ¤' },
  { id:1, hex:'#f97316', name:'æ©™' },
  { id:2, hex:'#eab308', name:'é»„' },
  { id:3, hex:'#22c55e', name:'ç·‘' },
  { id:4, hex:'#3b82f6', name:'é’' },
  { id:5, hex:'#8b5cf6', name:'ç´«' },
  { id:6, hex:'#ec4899', name:'æ¡ƒ' },
  { id:7, hex:'#14b8a6', name:'é’ç·‘' },
  { id:8, hex:'#f43f5e', name:'èµ¤æ¡ƒ' },
  { id:9, hex:'#a3e635', name:'é»„ç·‘' },
];

// Difficulty configs
const DIFFS = [
  { colors:4, tubes:6,  empties:2, capacity:4 }, // ã‹ã‚“ãŸã‚“
  { colors:5, tubes:7,  empties:2, capacity:4 }, // ãµã¤ã†
  { colors:6, tubes:8,  empties:2, capacity:4 }, // ã‚€ãšã‹ã—ã„
  null, // ã‚¹ãƒ†ãƒ¼ã‚¸ (dynamic)
];

const STAGE_CONFIGS = [
  { colors:3, tubes:5,  empties:2, capacity:4 },
  { colors:4, tubes:6,  empties:2, capacity:4 },
  { colors:5, tubes:7,  empties:2, capacity:4 },
  { colors:6, tubes:8,  empties:2, capacity:4 },
  { colors:7, tubes:9,  empties:2, capacity:4 },
  { colors:8, tubes:10, empties:2, capacity:4 },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let diffIdx  = 1;
let stageIdx = 0;
let tubes    = []; // array of arrays (bottomâ†’top)
let selected = -1;
let moves    = 0;
let history  = []; // for undo
let best     = JSON.parse(localStorage.getItem('pb-colorsort-best') || 'null');

// â”€â”€ Diff â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDiff(idx) {
  diffIdx = idx;
  document.querySelectorAll('#diffSeg .pb-seg-btn').forEach((b,i) => b.classList.toggle('active', i===idx));
  document.getElementById('statStageWrap').style.display = idx === 3 ? '' : 'none';
  stageIdx = 0;
  newGame();
}

function getConfig() {
  if (diffIdx === 3) return STAGE_CONFIGS[Math.min(stageIdx, STAGE_CONFIGS.length-1)];
  return DIFFS[diffIdx];
}

// â”€â”€ Generate puzzle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateTubes(cfg) {
  const { colors, tubes: tubeCount, empties, capacity } = cfg;
  // Create all balls: each color appears `capacity` times
  const balls = [];
  for (let c = 0; c < colors; c++) {
    for (let i = 0; i < capacity; i++) balls.push(c);
  }
  // Shuffle
  for (let i = balls.length-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [balls[i], balls[j]] = [balls[j], balls[i]];
  }
  // Fill tubes (non-empty ones)
  const result = [];
  const filledCount = tubeCount - empties;
  for (let t = 0; t < filledCount; t++) {
    result.push(balls.splice(0, capacity));
  }
  // Add empty tubes
  for (let t = 0; t < empties; t++) result.push([]);
  return result;
}

// â”€â”€ New game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newGame() {
  const cfg = getConfig();
  tubes    = generateTubes(cfg);
  selected = -1;
  moves    = 0;
  history  = [];
  document.getElementById('statMoves').textContent = 0;
  document.getElementById('statStage').textContent = stageIdx + 1;
  updateBestDisplay();
  render();
}

function nextLevel() {
  document.getElementById('resultOverlay').classList.remove('show');
  if (diffIdx === 3) {
    stageIdx = Math.min(stageIdx + 1, STAGE_CONFIGS.length - 1);
    document.getElementById('statStage').textContent = stageIdx + 1;
  }
  newGame();
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const wrap = document.getElementById('tubesWrap');
  const cfg  = getConfig();
  const { capacity } = cfg;

  // Set CSS vars for tube size
  const segH = Math.min(48, Math.floor(220 / capacity));
  const tubeH = segH * capacity;
  document.documentElement.style.setProperty('--tube-h', tubeH + 'px');
  document.documentElement.style.setProperty('--seg-h', segH + 'px');

  wrap.innerHTML = '';

  tubes.forEach((tube, ti) => {
    const outer = document.createElement('div');
    outer.className = 'tube-outer';
    outer.onclick = () => onTubeClick(ti);

    const tubeEl = document.createElement('div');
    tubeEl.className = 'tube' +
      (ti === selected ? ' selected' : '') +
      (isTubeComplete(tube, capacity) ? ' complete' : '') +
      (tube.length === 0 ? ' empty' : '');
    tubeEl.id = `tube-${ti}`;

    // Draw segments bottom to top
    tube.forEach((colorId, si) => {
      const seg = document.createElement('div');
      seg.className = 'seg';
      seg.style.background = COLORS[colorId].hex;
      tubeEl.appendChild(seg);
    });

    outer.appendChild(tubeEl);

    // Label: show color name if complete
    const label = document.createElement('div');
    label.className = 'tube-label';
    if (isTubeComplete(tube, capacity)) {
      label.textContent = COLORS[tube[0]].name + ' âœ“';
      label.style.color = COLORS[tube[0]].hex;
    } else {
      label.textContent = `${tube.length}/${capacity}`;
    }
    outer.appendChild(label);

    wrap.appendChild(outer);
  });
}

// â”€â”€ Tube click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTubeClick(ti) {
  const cfg = getConfig();
  const { capacity } = cfg;

  if (selected === -1) {
    // Select tube (only if not empty and not complete)
    if (tubes[ti].length === 0) return;
    if (isTubeComplete(tubes[ti], capacity)) return;
    selected = ti;
    render();
    return;
  }

  if (selected === ti) {
    // Deselect
    selected = -1;
    render();
    return;
  }

  // Try to pour selected â†’ ti
  const from = tubes[selected];
  const to   = tubes[ti];

  if (!canPour(from, to, capacity)) {
    // Shake the target tube
    const tubeEl = document.getElementById(`tube-${ti}`);
    if (tubeEl) { tubeEl.classList.add('shake'); setTimeout(() => tubeEl.classList.remove('shake'), 300); }
    selected = -1;
    render();
    return;
  }

  // Save history
  history.push(JSON.parse(JSON.stringify(tubes)));

  // Pour: move all matching top colors
  const topColor = from[from.length - 1];
  let count = 0;
  while (from.length > 0 && from[from.length-1] === topColor && to.length + count < capacity) {
    count++;
    from.pop();
    to.push(topColor);
  }

  moves++;
  document.getElementById('statMoves').textContent = moves;
  selected = -1;
  render();

  // Check win
  if (tubes.every(t => t.length === 0 || isTubeComplete(t, capacity))) {
    setTimeout(showResult, 400);
  }
}

function canPour(from, to, capacity) {
  if (from.length === 0) return false;
  if (to.length >= capacity) return false;
  if (to.length === 0) return true;
  return from[from.length-1] === to[to.length-1];
}

function isTubeComplete(tube, capacity) {
  if (tube.length !== capacity) return false;
  return tube.every(c => c === tube[0]);
}

// â”€â”€ Undo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function undoMove() {
  if (history.length === 0) return;
  tubes = history.pop();
  moves = Math.max(0, moves - 1);
  document.getElementById('statMoves').textContent = moves;
  selected = -1;
  render();
}

// â”€â”€ Result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult() {
  const isStage = diffIdx === 3;
  const key = `d${diffIdx}`;
  const isNew = !best || !best[key] || moves < best[key];
  if (isNew) {
    if (!best) best = {};
    best[key] = moves;
    localStorage.setItem('pb-colorsort-best', JSON.stringify(best));
  }

  document.getElementById('resMoves').textContent = moves + 'æ‰‹';
  document.getElementById('resBest').textContent = isNew ? 'ğŸ† æ–°è¨˜éŒ²ï¼' : `ãƒ™ã‚¹ãƒˆï¼š${best[key]}æ‰‹`;
  document.getElementById('resultNextBtn').style.display = isStage && stageIdx < STAGE_CONFIGS.length-1 ? '' : 'none';
  document.getElementById('resultOverlay').classList.add('show');
  updateBestDisplay();
}

function updateBestDisplay() {
  const key = `d${diffIdx}`;
  const el  = document.getElementById('statBest');
  el.textContent = (best && best[key]) ? best[key] + 'æ‰‹' : 'â€”';
}

// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const d = document.documentElement.classList.toggle('dark');
  document.getElementById('themeBtn').textContent = d ? 'ğŸŒ™' : 'ğŸŒ¤';
  localStorage.setItem('pb-theme', d ? 'dark' : 'light');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const saved = localStorage.getItem('pb-theme');
  const dark  = saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches);
  document.documentElement.classList.toggle('dark', dark);
  document.getElementById('themeBtn').textContent = dark ? 'ğŸŒ™' : 'ğŸŒ¤';
  updateBestDisplay();
  newGame();
})();
</script>
</body>
</html>
